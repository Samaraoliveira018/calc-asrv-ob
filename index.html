<script>
let dadosCalculados=[];

function salvarDados(){
  const cfg={
    bancaInicial:+document.getElementById("bancaInicial").value||400,
    investimentoPercentual:+document.getElementById("investimentoPercentual").value||10,
    payoutPercentual:+document.getElementById("payoutPercentual").value||88,
    operacoesPorDia:+document.getElementById("operacoesPorDia").value||2,
    diasPlanejamento:+document.getElementById("diasPlanejamento").value||30,
    tipoGerenciamento:document.querySelector('input[name="tipoGerenciamento"]:checked').value
  };
  localStorage.setItem("configBinarias",JSON.stringify(cfg));
}

function carregarDados(){
  const s=localStorage.getItem("configBinarias");
  if(!s)return;
  const c=JSON.parse(s);
  document.getElementById("bancaInicial").value=c.bancaInicial;
  document.getElementById("investimentoPercentual").value=c.investimentoPercentual;
  document.getElementById("payoutPercentual").value=c.payoutPercentual;
  document.getElementById("operacoesPorDia").value=c.operacoesPorDia;
  document.getElementById("diasPlanejamento").value=c.diasPlanejamento;
  if(c.tipoGerenciamento)
    document.querySelector(`input[value="${c.tipoGerenciamento}"]`).checked=true;
}

function calcularDados(){
  const bancaInicial=+document.getElementById("bancaInicial").value||400;
  const perc=+document.getElementById("investimentoPercentual").value||10;
  const payout=+document.getElementById("payoutPercentual").value||88;
  const ops=+document.getElementById("operacoesPorDia").value||2;
  const dias=+document.getElementById("diasPlanejamento").value||30;
  const tipo=document.querySelector('input[name="tipoGerenciamento"]:checked').value;

  dadosCalculados=[];
  let banca=bancaInicial;

  for(let d=1; d<=dias; d++){
    let totalInvestidoDia, entradaPorOperacao, lucroPorOperacao, lucroTotalDia, novaBanca;

    if(tipo==="fixo"){
      totalInvestidoDia = banca * (perc/100);
      const entrada = totalInvestidoDia / ops;
      const lucroOp = entrada * (payout/100);
      lucroTotalDia = lucroOp * ops;
      entradaPorOperacao = [ ...Array(ops) ].map(()=>entrada);
      lucroPorOperacao   = [ ...Array(ops) ].map(()=>lucroOp);
      novaBanca = banca + lucroTotalDia;

    } else { // --- MÃƒO DE SOROS ---
      const entradaBase = banca * (perc/100);
      const entradas = [];
      const lucros   = [];

      for(let i=0; i<ops; i++){
        const entradaAtual = (i===0) ? entradaBase : (entradaBase + lucros[i-1]);
        const lucroAtual   = entradaAtual * (payout/100);
        entradas.push(entradaAtual);
        lucros.push(lucroAtual);
      }

      entradaPorOperacao = entradas;
      lucroPorOperacao   = lucros;
      totalInvestidoDia  = entradas.reduce((s,v)=>s+v,0);
      lucroTotalDia      = lucros.reduce((s,v)=>s+v,0);
      novaBanca          = banca + lucroTotalDia;
    }

    dadosCalculados.push({
      dia: d,
      bancaInicial: banca,
      investimentoPercentual: perc,
      totalInvestidoDia,
      operacoesPorDia: ops,
      entradaPorOperacao,
      lucroPorOperacao,
      lucroTotalDia, // ðŸ’° lucro diÃ¡rio total
      novaBanca,
      tipoGerenciamento: tipo
    });

    banca = novaBanca;
  }

  atualizarPreview();
  salvarDados();
}

function atualizarPreview(){
  if(!dadosCalculados.length)return;

  const bi=dadosCalculados[0].bancaInicial;
  const bf=dadosCalculados.at(-1).novaBanca;
  const lucroTotal=bf-bi;
  const crescimento=((bf-bi)/bi)*100;
  const lucroMedioDia = lucroTotal / dadosCalculados.length;

  document.getElementById("previewBancaFinal").textContent=`R$ ${bf.toFixed(2)}`;
  document.getElementById("previewLucroTotal").textContent=`R$ ${lucroTotal.toFixed(2)}`;
  document.getElementById("previewCrescimento").textContent=`${crescimento.toFixed(1)}%`;
  document.getElementById("previewEntradaPorOp").textContent=`R$ ${dadosCalculados[0].entradaPorOperacao[0].toFixed(2)}`;
  document.getElementById("previewLucroPorOp").textContent=`R$ ${dadosCalculados[0].lucroPorOperacao[0].toFixed(2)}`;

  const t=document.getElementById("previewTable");
  t.innerHTML="";
  dadosCalculados.forEach(r=>{
    const entradaDisp = Array.isArray(r.entradaPorOperacao)
      ? r.entradaPorOperacao.map((v,i)=>`${i+1}Âª: R$ ${v.toFixed(2)}`).join(" â†’ ")
      : `R$ ${r.entradaPorOperacao.toFixed(2)}`;

    const lucroDisp = Array.isArray(r.lucroPorOperacao)
      ? r.lucroPorOperacao.map((v,i)=>`${i+1}Âª: R$ ${v.toFixed(2)}`).join(" â†’ ")
      : `R$ ${r.lucroPorOperacao.toFixed(2)}`;

    t.innerHTML += `
      <tr>
        <td>${r.dia}</td>
        <td class="currency">R$ ${r.bancaInicial.toFixed(2)}</td>
        <td>${r.investimentoPercentual}%</td>
        <td class="currency">R$ ${r.totalInvestidoDia.toFixed(2)}</td>
        <td>${r.operacoesPorDia}</td>
        <td class="currency">${entradaDisp}</td>
        <td class="currency">${lucroDisp}</td>
        <td class="currency"><strong>R$ ${r.lucroTotalDia.toFixed(2)}</strong></td>
        <td class="currency">R$ ${r.novaBanca.toFixed(2)}</td>
        <td>${r.tipoGerenciamento}</td>
      </tr>`;
  });

  // ðŸ§¾ RESUMO FINAL ABAIXO DA TABELA
  const resumoHTML = `
    <tr style="background:#e3f2fd;font-weight:bold;">
      <td colspan="3">Totais</td>
      <td colspan="2"></td>
      <td>Lucro Total Acumulado:</td>
      <td class="currency">R$ ${lucroTotal.toFixed(2)}</td>
      <td>Crescimento:</td>
      <td class="currency">${crescimento.toFixed(2)}%</td>
      <td>Lucro MÃ©dio/Dia: R$ ${lucroMedioDia.toFixed(2)}</td>
    </tr>`;
  t.innerHTML += resumoHTML;
}

function gerarPlanilhaCSV(){
  if(!dadosCalculados.length)return;
  let csv="Dia,Banca Inicial,% Investido,Total Investido,Ops/Dia,Entrada/Op,Lucro/Op,Lucro DiÃ¡rio Total,Nova Banca,Gerenciamento\n";
  dadosCalculados.forEach(i=>{
    const entradaDisp = Array.isArray(i.entradaPorOperacao)
      ? i.entradaPorOperacao.map((v,j)=>`${j+1}Âª:R$${v.toFixed(2)}`).join(">")
      : i.entradaPorOperacao.toFixed(2);
    const lucroDisp = Array.isArray(i.lucroPorOperacao)
      ? i.lucroPorOperacao.map((v,j)=>`${j+1}Âª:R$${v.toFixed(2)}`).join(">")
      : i.lucroPorOperacao.toFixed(2);
    csv += `${i.dia},${i.bancaInicial.toFixed(2)},${i.investimentoPercentual},${i.totalInvestidoDia.toFixed(2)},${i.operacoesPorDia},"${entradaDisp}","${lucroDisp}",${i.lucroTotalDia.toFixed(2)},${i.novaBanca.toFixed(2)},${i.tipoGerenciamento}\n`;
  });
  const bi=dadosCalculados[0].bancaInicial;
  const bf=dadosCalculados.at(-1).novaBanca;
  const lucroTotal=bf-bi;
  const crescimento=((bf-bi)/bi)*100;
  const lucroMedioDia = lucroTotal / dadosCalculados.length;
  csv += `\nRESUMO,,,\nLucro Total Acumulado,R$ ${lucroTotal.toFixed(2)}\nCrescimento,${crescimento.toFixed(2)}%\nLucro MÃ©dio DiÃ¡rio,R$ ${lucroMedioDia.toFixed(2)}\n`;

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="gerenciamento.csv";
  link.click();
}

/* === EVENTOS === */
["bancaInicial","investimentoPercentual","payoutPercentual","operacoesPorDia","diasPlanejamento"]
.forEach(id=>document.getElementById(id).addEventListener("input",calcularDados));
document.querySelectorAll('input[name="tipoGerenciamento"]').forEach(r=>r.addEventListener("change",calcularDados));

carregarDados();
calcularDados();
</script>
