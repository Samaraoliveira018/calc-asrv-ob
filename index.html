<script>
document.addEventListener("DOMContentLoaded", () => {

let dadosCalculados=[];

function salvarDados(){
  const cfg={
    bancaInicial:+document.getElementById("bancaInicial").value||400,
    investimentoPercentual:+document.getElementById("investimentoPercentual").value||10,
    payoutPercentual:+document.getElementById("payoutPercentual").value||88,
    operacoesPorDia:+document.getElementById("operacoesPorDia").value||2,
    diasPlanejamento:+document.getElementById("diasPlanejamento").value||30,
    tipoGerenciamento:document.querySelector('input[name="tipoGerenciamento"]:checked')?.value||"fixo"
  };
  localStorage.setItem("configBinarias",JSON.stringify(cfg));
}

function carregarDados(){
  const s=localStorage.getItem("configBinarias");
  if(!s)return;
  const c=JSON.parse(s);

  const ids=["bancaInicial","investimentoPercentual","payoutPercentual","operacoesPorDia","diasPlanejamento"];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el && c[id]!==undefined) el.value=c[id];
  });

  // evita erro caso os inputs ainda n√£o existam
  if(c.tipoGerenciamento){
    const radio=document.querySelector(`input[name="tipoGerenciamento"][value="${c.tipoGerenciamento}"]`);
    if(radio) radio.checked=true;
  }
}

function formatar(valor){
  return valor.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
}

function calcularDados(){
  const bancaInicial=+document.getElementById("bancaInicial").value||400;
  const perc=+document.getElementById("investimentoPercentual").value||10;
  const payout=+document.getElementById("payoutPercentual").value||88;
  const ops=+document.getElementById("operacoesPorDia").value||2;
  const dias=+document.getElementById("diasPlanejamento").value||30;
  const tipo=document.querySelector('input[name="tipoGerenciamento"]:checked')?.value||"fixo";

  dadosCalculados=[];
  let banca=bancaInicial;

  for(let d=1; d<=dias; d++){
    let totalInvestidoDia, entradaPorOperacao, lucroPorOperacao, lucroTotalDia, novaBanca;

    if(tipo==="fixo"){
      totalInvestidoDia=banca*(perc/100);
      const entrada=totalInvestidoDia/ops;
      const lucroOp=entrada*(payout/100);
      lucroTotalDia=lucroOp*ops;
      entradaPorOperacao=Array(ops).fill(entrada);
      lucroPorOperacao=Array(ops).fill(lucroOp);
      novaBanca=banca+lucroTotalDia;
    } else {
      const entradaBase=banca*(perc/100);
      const entradas=[],lucros=[];
      for(let i=0;i<ops;i++){
        const entradaAtual=(i===0)?entradaBase:(entradaBase+lucros[i-1]);
        const lucroAtual=entradaAtual*(payout/100);
        entradas.push(entradaAtual);
        lucros.push(lucroAtual);
      }
      entradaPorOperacao=entradas;
      lucroPorOperacao=lucros;
      totalInvestidoDia=entradas.reduce((s,v)=>s+v,0);
      lucroTotalDia=lucros.reduce((s,v)=>s+v,0);
      novaBanca=banca+lucroTotalDia;
    }

    dadosCalculados.push({
      dia:d,
      bancaInicial:banca,
      investimentoPercentual:perc,
      totalInvestidoDia,
      operacoesPorDia:ops,
      entradaPorOperacao,
      lucroPorOperacao,
      lucroTotalDia,
      novaBanca,
      tipoGerenciamento:tipo,
      resultado:"none"
    });
    banca=novaBanca;
  }

  atualizarPreview();
  salvarDados();
}

function aplicarResultado(diaIndex,resultado){
  const d=dadosCalculados[diaIndex];

  if(resultado==="loss1"){ 
    const perda=d.entradaPorOperacao[0];
    d.lucroTotalDia=-perda;
    d.novaBanca=d.bancaInicial-perda;
    d.resultado="Loss 1¬™";
  } 
  else if(resultado==="loss2"){
    const perda=d.entradaPorOperacao[1];
    d.lucroTotalDia-=perda;
    d.novaBanca=d.bancaInicial+d.lucroTotalDia;
    d.resultado="Loss 2¬™";
  } else d.resultado="Win";

  // Recalcular os dias seguintes
  for(let i=diaIndex+1;i<dadosCalculados.length;i++){
    const prev=dadosCalculados[i-1];
    dadosCalculados[i].bancaInicial=prev.novaBanca;
    const perc=dadosCalculados[i].investimentoPercentual;
    const payout=+document.getElementById("payoutPercentual").value/100;

    if(dadosCalculados[i].tipoGerenciamento==="soros"){
      const base=prev.novaBanca*(perc/100);
      const entradas=[],lucros=[];
      for(let j=0;j<dadosCalculados[i].operacoesPorDia;j++){
        const e=(j===0)?base:(base+lucros[j-1]);
        const l=e*payout;
        entradas.push(e);lucros.push(l);
      }
      dadosCalculados[i].entradaPorOperacao=entradas;
      dadosCalculados[i].lucroPorOperacao=lucros;
      dadosCalculados[i].lucroTotalDia=lucros.reduce((s,v)=>s+v,0);
      dadosCalculados[i].novaBanca=prev.novaBanca+dadosCalculados[i].lucroTotalDia;
    } else {
      const total=prev.novaBanca*(perc/100);
      const entrada=total/dadosCalculados[i].operacoesPorDia;
      const lucro=entrada*payout;
      dadosCalculados[i].entradaPorOperacao=Array(dadosCalculados[i].operacoesPorDia).fill(entrada);
      dadosCalculados[i].lucroPorOperacao=Array(dadosCalculados[i].operacoesPorDia).fill(lucro);
      dadosCalculados[i].lucroTotalDia=lucro*dadosCalculados[i].operacoesPorDia;
      dadosCalculados[i].novaBanca=prev.novaBanca+dadosCalculados[i].lucroTotalDia;
    }
    dadosCalculados[i].resultado="none";
  }

  atualizarPreview();
}

function resetarSimulacao(limparConfig=false){
  dadosCalculados.forEach(d=>d.resultado="none");
  if(limparConfig){
    localStorage.removeItem("configBinarias");
  }
  calcularDados();
}

function atualizarPreview(){
  if(!dadosCalculados.length)return;

  const bi=dadosCalculados[0].bancaInicial;
  const bf=dadosCalculados.at(-1).novaBanca;
  const lucroTotal=bf-bi;
  const crescimento=((bf-bi)/bi)*100;
  const lucroMedioDia=lucroTotal/dadosCalculados.length;

  document.getElementById("previewBancaFinal").textContent=`R$ ${formatar(bf)}`;
  document.getElementById("previewLucroTotal").textContent=`R$ ${formatar(lucroTotal)}`;
  document.getElementById("previewCrescimento").textContent=`${crescimento.toFixed(1)}%`;
  document.getElementById("previewEntradaPorOp").textContent=`R$ ${formatar(dadosCalculados[0].entradaPorOperacao[0])}`;
  document.getElementById("previewLucroPorOp").textContent=`R$ ${formatar(dadosCalculados[0].lucroPorOperacao[0])}`;

  const t=document.getElementById("previewTable");
  t.innerHTML="";

  // Bot√£o reset
  t.innerHTML+=`
    <tr style="background:#f0f0f0;">
      <td colspan="10" style="text-align:right;">
        <button onclick="resetarSimulacao()" style="background:#3498db;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;margin-right:5px;">
          üîÑ Resetar Simula√ß√£o
        </button>
        <button onclick="resetarSimulacao(true)" style="background:#e74c3c;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">
          üßπ Resetar Tudo
        </button>
      </td>
    </tr>`;

  dadosCalculados.forEach((r,i)=>{
    const entradaDisp=r.entradaPorOperacao.map((v,j)=>`${j+1}¬™: R$ ${formatar(v)}`).join(" ‚Üí ");
    const lucroDisp=r.lucroPorOperacao.map((v,j)=>`${j+1}¬™: R$ ${formatar(v)}`).join(" ‚Üí ");

    let bgColor="";
    if(r.resultado==="Win") bgColor="style='background:#d4edda'";
    else if(r.resultado==="Loss 1¬™") bgColor="style='background:#f8d7da'";
    else if(r.resultado==="Loss 2¬™") bgColor="style='background:#fff3cd'";

    t.innerHTML+=`
      <tr ${bgColor}>
        <td>${r.dia}</td>
        <td class="currency">R$ ${formatar(r.bancaInicial)}</td>
        <td>${r.investimentoPercentual}%</td>
        <td>${entradaDisp}</td>
        <td>${lucroDisp}</td>
        <td class="currency"><strong>R$ ${formatar(r.lucroTotalDia)}</strong></td>
        <td class="currency">R$ ${formatar(r.novaBanca)}</td>
        <td>${r.tipoGerenciamento}</td>
        <td>
          <button onclick="aplicarResultado(${i},'win')" style="background:#2ecc71;color:#fff;border:none;padding:5px 8px;border-radius:6px;">‚úÖ</button>
          <button onclick="aplicarResultado(${i},'loss1')" style="background:#e74c3c;color:#fff;border:none;padding:5px 8px;border-radius:6px;">‚ùå 1¬™</button>
          <button onclick="aplicarResultado(${i},'loss2')" style="background:#f39c12;color:#fff;border:none;padding:5px 8px;border-radius:6px;">‚ö†Ô∏è 2¬™</button>
        </td>
      </tr>`;
  });

  const resumoHTML=`
    <tr style="background:#e3f2fd;font-weight:bold;">
      <td colspan="3">Totais</td>
      <td colspan="2"></td>
      <td>Lucro Total Acumulado:</td>
      <td class="currency">R$ ${formatar(lucroTotal)}</td>
      <td>Crescimento:</td>
      <td class="currency">${crescimento.toFixed(2)}%</td>
      <td>Lucro M√©dio/Dia: R$ ${formatar(lucroMedioDia)}</td>
    </tr>`;
  t.innerHTML+=resumoHTML;
}

/* === EVENTOS === */
["bancaInicial","investimentoPercentual","payoutPercentual","operacoesPorDia","diasPlanejamento"]
.forEach(id=>document.getElementById(id)?.addEventListener("input",calcularDados));
document.querySelectorAll('input[name="tipoGerenciamento"]').forEach(r=>r.addEventListener("change",calcularDados));

carregarDados();
calcularDados();

});
</script>
